/*
    IconvQtPOC - Integrating iconv() for Unicode Conversion in Qt apps
    Copyright (C) 2022 Pedro Lopez-Cabanillas
    
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
    
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
    
    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/

#include <QMap>
#include <QFileDialog>
#include <QDebug>
#include <QDataStream>
#include <QFile>
#include <uchardet.h>

#include "iconvconverter.h"
#include "mainwindow.h"
#include "ui_mainwindow.h"

QMap<int, QByteArray> charsets{
    {3,"US-ASCII"},
    {4,"ISO-8859-1"},
    {5,"ISO-8859-2"},
    {6,"ISO-8859-3"},
    {7,"ISO-8859-4"},
    {8,"ISO-8859-5"},
    {9,"ISO-8859-6"},
    {10,"ISO-8859-7"},
    {11,"ISO-8859-8"},
    {12,"ISO-8859-9"},
    {13,"ISO-8859-10"},
    {14,"ISO_6937-2-ADD"},
    {15,"JIS_X0201"},
    {16,"JIS_ENCODING"},
    {17,"SHIFT_JIS"},
    {18,"EUC-JP"},
    {19,"EXTENDED_UNIX_CODE_FIXED_WIDTH_FOR_JAPANESE"},
    {20,"BS_4730"},
    {21,"SEN_850200_C"},
    {22,"IT"},
    {23,"ES"},
    {24,"DIN_66003"},
    {25,"NS_4551-1"},
    {26,"NF_Z_62-010"},
    {27,"ISO-10646-UTF-1"},
    {28,"ISO_646.BASIC:1983"},
    {29,"INVARIANT"},
    {30,"ISO_646.IRV:1983"},
    {31,"NATS-SEFI"},
    {32,"NATS-SEFI-ADD"},
    {33,"NATS-DANO"},
    {34,"NATS-DANO-ADD"},
    {35,"SEN_850200_B"},
    {36,"KS_C_5601-1987"},
    {37,"ISO-2022-KR"},
    {38,"EUC-KR"},
    {39,"ISO-2022-JP"},
    {40,"ISO-2022-JP-2"},
    {41,"JIS_C6220-1969-JP"},
    {42,"JIS_C6220-1969-RO"},
    {43,"PT"},
    {44,"GREEK7-OLD"},
    {45,"LATIN-GREEK"},
    {46,"NF_Z_62-010_(1973)"},
    {47,"LATIN-GREEK-1"},
    {48,"ISO_5427"},
    {49,"JIS_C6226-1978"},
    {50,"BS_VIEWDATA"},
    {51,"INIS"},
    {52,"INIS-8"},
    {53,"INIS-CYRILLIC"},
    {54,"ISO_5427:1981"},
    {55,"ISO_5428:1980"},
    {56,"GB_1988-80"},
    {57,"GB_2312-80"},
    {58,"NS_4551-2"},
    {59,"VIDEOTEX-SUPPL"},
    {60,"PT2"},
    {61,"ES2"},
    {62,"MSZ_7795.3"},
    {63,"JIS_C6226-1983"},
    {64,"GREEK7"},
    {65,"ASMO_449"},
    {66,"ISO-IR-90"},
    {67,"JIS_C6229-1984-A"},
    {68,"JIS_C6229-1984-B"},
    {69,"JIS_C6229-1984-B-ADD"},
    {70,"JIS_C6229-1984-HAND"},
    {71,"JIS_C6229-1984-HAND-ADD"},
    {72,"JIS_C6229-1984-KANA"},
    {73,"ISO_2033-1983"},
    {74,"ANSI_X3.110-1983"},
    {75,"T.61-7BIT"},
    {76,"T.61-8BIT"},
    {77,"ECMA-CYRILLIC"},
    {78,"CSA_Z243.4-1985-1"},
    {79,"CSA_Z243.4-1985-2"},
    {80,"CSA_Z243.4-1985-GR"},
    {81,"ISO-8859-6-E"},
    {82,"ISO-8859-6-I"},
    {83,"T.101-G2"},
    {84,"ISO-8859-8-E"},
    {85,"ISO-8859-8-I"},
    {86,"CSN_369103"},
    {87,"JUS_I.B1.002"},
    {88,"IEC_P27-1"},
    {89,"JUS_I.B1.003-SERB"},
    {90,"JUS_I.B1.003-MAC"},
    {91,"GREEK-CCITT"},
    {92,"NC_NC00-10:81"},
    {93,"ISO_6937-2-25"},
    {94,"GOST_19768-74"},
    {95,"ISO_8859-SUPP"},
    {96,"ISO_10367-BOX"},
    {97,"LATIN-LAP"},
    {98,"JIS_X0212-1990"},
    {99,"DS_2089"},
    {100,"US-DK"},
    {101,"DK-US"},
    {102,"KSC5636"},
    {103,"UNICODE-1-1-UTF-7"},
    {104,"ISO-2022-CN"},
    {105,"ISO-2022-CN-EXT"},
    {106,"UTF-8"},
    {109,"ISO-8859-13"},
    {110,"ISO-8859-14"},
    {111,"ISO-8859-15"},
    {112,"ISO-8859-16"},
    {113,"GBK"},
    {114,"GB18030"},
    {115,"OSD_EBCDIC_DF04_15"},
    {116,"OSD_EBCDIC_DF03_IRV"},
    {117,"OSD_EBCDIC_DF04_1"},
    {118,"ISO-11548-1"},
    {119,"KZ-1048"},
    {1000,"ISO-10646-UCS-2"},
    {1001,"ISO-10646-UCS-4"},
    {1002,"ISO-10646-UCS-BASIC"},
    {1003,"ISO-10646-UNICODE-LATIN1"},
    {1004,"ISO-10646-J-1"},
    {1005,"ISO-UNICODE-IBM-1261"},
    {1006,"ISO-UNICODE-IBM-1268"},
    {1007,"ISO-UNICODE-IBM-1276"},
    {1008,"ISO-UNICODE-IBM-1264"},
    {1009,"ISO-UNICODE-IBM-1265"},
    {1010,"UNICODE-1-1"},
    {1011,"SCSU"},
    {1012,"UTF-7"},
    {1013,"UTF-16BE"},
    {1014,"UTF-16LE"},
    {1015,"UTF-16"},
    {1016,"CESU-8"},
    {1017,"UTF-32"},
    {1018,"UTF-32BE"},
    {1019,"UTF-32LE"},
    {1020,"BOCU-1"},
    {1021,"UTF-7-IMAP"},
    {2000,"ISO-8859-1-WINDOWS-3.0-LATIN-1"},
    {2001,"ISO-8859-1-WINDOWS-3.1-LATIN-1"},
    {2002,"ISO-8859-2-WINDOWS-LATIN-2"},
    {2003,"ISO-8859-9-WINDOWS-LATIN-5"},
    {2004,"HP-ROMAN8"},
    {2005,"ADOBE-STANDARD-ENCODING"},
    {2006,"VENTURA-US"},
    {2007,"VENTURA-INTERNATIONAL"},
    {2008,"DEC-MCS"},
    {2009,"IBM850"},
    {2010,"IBM852"},
    {2011,"IBM437"},
    {2012,"PC8-DANISH-NORWEGIAN"},
    {2013,"IBM862"},
    {2014,"PC8-TURKISH"},
    {2015,"IBM-SYMBOLS"},
    {2016,"IBM-THAI"},
    {2017,"HP-LEGAL"},
    {2018,"HP-PI-FONT"},
    {2019,"HP-MATH8"},
    {2020,"ADOBE-SYMBOL-ENCODING"},
    {2021,"HP-DESKTOP"},
    {2022,"VENTURA-MATH"},
    {2023,"MICROSOFT-PUBLISHING"},
    {2024,"WINDOWS-31J"},
    {2025,"GB2312"},
    {2026,"BIG5"},
    {2027,"MACINTOSH"},
    {2028,"IBM037"},
    {2029,"IBM038"},
    {2030,"IBM273"},
    {2031,"IBM274"},
    {2032,"IBM275"},
    {2033,"IBM277"},
    {2034,"IBM278"},
    {2035,"IBM280"},
    {2036,"IBM281"},
    {2037,"IBM284"},
    {2038,"IBM285"},
    {2039,"IBM290"},
    {2040,"IBM297"},
    {2041,"IBM420"},
    {2042,"IBM423"},
    {2043,"IBM424"},
    {2044,"IBM500"},
    {2045,"IBM851"},
    {2046,"IBM855"},
    {2047,"IBM857"},
    {2048,"IBM860"},
    {2049,"IBM861"},
    {2050,"IBM863"},
    {2051,"IBM864"},
    {2052,"IBM865"},
    {2053,"IBM868"},
    {2054,"IBM869"},
    {2055,"IBM870"},
    {2056,"IBM871"},
    {2057,"IBM880"},
    {2058,"IBM891"},
    {2059,"IBM903"},
    {2060,"IBM904"},
    {2061,"IBM905"},
    {2062,"IBM918"},
    {2063,"IBM1026"},
    {2064,"EBCDIC-AT-DE"},
    {2065,"EBCDIC-AT-DE-A"},
    {2066,"EBCDIC-CA-FR"},
    {2067,"EBCDIC-DK-NO"},
    {2068,"EBCDIC-DK-NO-A"},
    {2069,"EBCDIC-FI-SE"},
    {2070,"EBCDIC-FI-SE-A"},
    {2071,"EBCDIC-FR"},
    {2072,"EBCDIC-IT"},
    {2073,"EBCDIC-PT"},
    {2074,"EBCDIC-ES"},
    {2075,"EBCDIC-ES-A"},
    {2076,"EBCDIC-ES-S"},
    {2077,"EBCDIC-UK"},
    {2078,"EBCDIC-US"},
    {2079,"UNKNOWN-8BIT"},
    {2080,"MNEMONIC"},
    {2081,"MNEM"},
    {2082,"VISCII"},
    {2083,"VIQR"},
    {2084,"KOI8-R"},
    {2085,"HZ-GB-2312"},
    {2086,"IBM866"},
    {2087,"IBM775"},
    {2088,"KOI8-U"},
    {2089,"IBM00858"},
    {2090,"IBM00924"},
    {2091,"IBM01140"},
    {2092,"IBM01141"},
    {2093,"IBM01142"},
    {2094,"IBM01143"},
    {2095,"IBM01144"},
    {2096,"IBM01145"},
    {2097,"IBM01146"},
    {2098,"IBM01147"},
    {2099,"IBM01148"},
    {2100,"IBM01149"},
    {2101,"BIG5-HKSCS"},
    {2102,"IBM1047"},
    {2103,"PTCP154"},
    {2104,"AMIGA-1251"},
    {2105,"KOI7-SWITCHED"},
    {2106,"BRF"},
    {2107,"TSCII"},
    {2108,"CP51932"},
    {2109,"WINDOWS-874"},
    {2250,"WINDOWS-1250"},
    {2251,"WINDOWS-1251"},
    {2252,"WINDOWS-1252"},
    {2253,"WINDOWS-1253"},
    {2254,"WINDOWS-1254"},
    {2255,"WINDOWS-1255"},
    {2256,"WINDOWS-1256"},
    {2257,"WINDOWS-1257"},
    {2258,"WINDOWS-1258"},
    {2259,"TIS-620"},
    {2260,"CP50220"},
    {9991,"EUC-TW"},
    {10029,"MAC-CENTRALEUROPE"},
    {10007,"MAC-CYRILLIC"}    
};

QMap<QByteArray, int> aliases{
    {"437",2011},
    {"850",2009},
    {"851",2045},
    {"852",2010},
    {"855",2046},
    {"857",2047},
    {"860",2048},
    {"861",2049},
    {"862",2013},
    {"863",2050},
    {"865",2052},
    {"866",2086},
    {"869",2054},
    {"904",2060},
    {"ADOBE-STANDARD-ENCODING",2005},
    {"ADOBE-SYMBOL-ENCODING",2020},
    {"AMI-1251",2104},
    {"AMI1251",2104},
    {"AMIGA-1251",2104},
    {"AMIGA1251",2104},
    {"ANSI_X3.110-1983",74},
    {"ANSI_X3.4-1968",3},
    {"ANSI_X3.4-1986",3},
    {"ARABIC",9},
    {"ARABIC7",65},
    {"ASCII",3},
    {"ASMO-708",9},
    {"ASMO_449",65},
    {"BIG5",2026},
    {"BIG5-HKSCS",2101},
    {"BOCU-1",1020},
    {"BRF",2106},
    {"BS_4730",20},
    {"BS_VIEWDATA",50},
    {"CA",78},
    {"CCSID00858",2089},
    {"CCSID00924",2090},
    {"CCSID01140",2091},
    {"CCSID01141",2092},
    {"CCSID01142",2093},
    {"CCSID01143",2094},
    {"CCSID01144",2095},
    {"CCSID01145",2096},
    {"CCSID01146",2097},
    {"CCSID01147",2098},
    {"CCSID01148",2099},
    {"CCSID01149",2100},
    {"CESU-8",1016},
    {"CHINESE",57},
    {"CN",56},
    {"CP-AR",2053},
    {"CP-GR",2054},
    {"CP-IS",2049},
    {"CP00858",2089},
    {"CP00924",2090},
    {"CP01140",2091},
    {"CP01141",2092},
    {"CP01142",2093},
    {"CP01143",2094},
    {"CP01144",2095},
    {"CP01145",2096},
    {"CP01146",2097},
    {"CP01147",2098},
    {"CP01148",2099},
    {"CP01149",2100},
    {"CP037",2028},
    {"CP038",2029},
    {"CP1026",2063},
    {"CP154",2103},
    {"CP273",2030},
    {"CP274",2031},
    {"CP275",2032},
    {"CP278",2034},
    {"CP280",2035},
    {"CP281",2036},
    {"CP284",2037},
    {"CP285",2038},
    {"CP290",2039},
    {"CP297",2040},
    {"CP367",3},
    {"CP420",2041},
    {"CP423",2042},
    {"CP424",2043},
    {"CP437",2011},
    {"CP500",2044},
    {"CP50220",2260},
    {"CP51932",2108},
    {"CP775",2087},
    {"CP819",4},
    {"CP850",2009},
    {"CP851",2045},
    {"CP852",2010},
    {"CP855",2046},
    {"CP857",2047},
    {"CP860",2048},
    {"CP861",2049},
    {"CP862",2013},
    {"CP863",2050},
    {"CP864",2051},
    {"CP865",2052},
    {"CP866",2086},
    {"CP868",2053},
    {"CP869",2054},
    {"CP870",2055},
    {"CP871",2056},
    {"CP880",2057},
    {"CP891",2058},
    {"CP903",2059},
    {"CP904",2060},
    {"CP905",2061},
    {"CP918",2062},
    {"CP936",113},
    {"CSA7-1",78},
    {"CSA7-2",79},
    {"CSA71",78},
    {"CSA72",79},
    {"CSADOBESTANDARDENCODING",2005},
    {"CSAMIGA1251",2104},
    {"CSASCII",3},
    {"CSA_T500-1983",74},
    {"CSA_Z243.4-1985-1",78},
    {"CSA_Z243.4-1985-2",79},
    {"CSA_Z243.4-1985-GR",80},
    {"CSBIG5",2026},
    {"CSBIG5HKSCS",2101},
    {"CSBOCU-1",1020},
    {"CSBOCU1",1020},
    {"CSBRF",2106},
    {"CSCESU-8",1016},
    {"CSCESU8",1016},
    {"CSCP50220",2260},
    {"CSCP51932",2108},
    {"CSDECMCS",2008},
    {"CSDKUS",101},
    {"CSEBCDICATDEA",2065},
    {"CSEBCDICCAFR",2066},
    {"CSEBCDICDKNO",2067},
    {"CSEBCDICDKNOA",2068},
    {"CSEBCDICES",2074},
    {"CSEBCDICESA",2075},
    {"CSEBCDICESS",2076},
    {"CSEBCDICFISE",2069},
    {"CSEBCDICFISEA",2070},
    {"CSEBCDICFR",2071},
    {"CSEBCDICIT",2072},
    {"CSEBCDICPT",2073},
    {"CSEBCDICUK",2077},
    {"CSEBCDICUS",2078},
    {"CSEUCFIXWIDJAPANESE",19},
    {"CSEUCKR",38},
    {"CSEUCPKDFMTJAPANESE",18},
    {"CSGB18030",114},
    {"CSGB2312",2025},
    {"CSGBK",113},
    {"CSHALFWIDTHKATAKANA",15},
    {"CSHPDESKTOP",2021},
    {"CSHPLEGAL",2017},
    {"CSHPMATH8",2019},
    {"CSHPPIFONT",2018},
    {"CSHPPSMATH",2020},
    {"CSHPROMAN8",2004},
    {"CSIBBM904",2060},
    {"CSIBM00858",2089},
    {"CSIBM00924",2090},
    {"CSIBM01140",2091},
    {"CSIBM01141",2092},
    {"CSIBM01142",2093},
    {"CSIBM01143",2094},
    {"CSIBM01144",2095},
    {"CSIBM01145",2096},
    {"CSIBM01146",2097},
    {"CSIBM01147",2098},
    {"CSIBM01148",2099},
    {"CSIBM01149",2100},
    {"CSIBM037",2028},
    {"CSIBM038",2029},
    {"CSIBM1026",2063},
    {"CSIBM1047",2102},
    {"CSIBM273",2030},
    {"CSIBM274",2031},
    {"CSIBM275",2032},
    {"CSIBM277",2033},
    {"CSIBM278",2034},
    {"CSIBM280",2035},
    {"CSIBM281",2036},
    {"CSIBM284",2037},
    {"CSIBM285",2038},
    {"CSIBM290",2039},
    {"CSIBM297",2040},
    {"CSIBM420",2041},
    {"CSIBM423",2042},
    {"CSIBM424",2043},
    {"CSIBM500",2044},
    {"CSIBM851",2045},
    {"CSIBM855",2046},
    {"CSIBM857",2047},
    {"CSIBM860",2048},
    {"CSIBM861",2049},
    {"CSIBM863",2050},
    {"CSIBM864",2051},
    {"CSIBM865",2052},
    {"CSIBM866",2086},
    {"CSIBM868",2053},
    {"CSIBM869",2054},
    {"CSIBM870",2055},
    {"CSIBM871",2056},
    {"CSIBM880",2057},
    {"CSIBM891",2058},
    {"CSIBM903",2059},
    {"CSIBM905",2061},
    {"CSIBM918",2062},
    {"CSIBMEBCDICATDE",2064},
    {"CSIBMSYMBOLS",2015},
    {"CSIBMTHAI",2016},
    {"CSINVARIANT",29},
    {"CSISO102T617BIT",75},
    {"CSISO10367BOX",96},
    {"CSISO103T618BIT",76},
    {"CSISO10646UTF1",27},
    {"CSISO10SWEDISH",35},
    {"CSISO111ECMACYRILLIC",77},
    {"CSISO115481",118},
    {"CSISO11SWEDISHFORNAMES",21},
    {"CSISO121CANADIAN1",78},
    {"CSISO122CANADIAN2",79},
    {"CSISO123CSAZ24341985GR",80},
    {"CSISO128T101G2",83},
    {"CSISO139CSN369103",86},
    {"CSISO13JISC6220JP",41},
    {"CSISO141JUSIB1002",87},
    {"CSISO143IECP271",88},
    {"CSISO146SERBIAN",89},
    {"CSISO147MACEDONIAN",90},
    {"CSISO14JISC6220RO",42},
    {"CSISO150",91},
    {"CSISO150GREEKCCITT",91},
    {"CSISO151CUBA",92},
    {"CSISO153GOST1976874",94},
    {"CSISO158LAP",97},
    {"CSISO159JISX02121990",98},
    {"CSISO15ITALIAN",22},
    {"CSISO16PORTUGUESE",43},
    {"CSISO17SPANISH",23},
    {"CSISO18GREEK7OLD",44},
    {"CSISO19LATINGREEK",45},
    {"CSISO2022CN",104},
    {"CSISO2022CNEXT",105},
    {"CSISO2022JP",39},
    {"CSISO2022JP2",40},
    {"CSISO2022KR",37},
    {"CSISO2033",73},
    {"CSISO21GERMAN",24},
    {"CSISO25FRENCH",46},
    {"CSISO27LATINGREEK1",47},
    {"CSISO2INTLREFVERSION",30},
    {"CSISO42JISC62261978",49},
    {"CSISO47BSVIEWDATA",50},
    {"CSISO49INIS",51},
    {"CSISO4UNITEDKINGDOM",20},
    {"CSISO50INIS8",52},
    {"CSISO51INISCYRILLIC",53},
    {"CSISO54271981",54},
    {"CSISO5427CYRILLIC",48},
    {"CSISO5428GREEK",55},
    {"CSISO57GB1988",56},
    {"CSISO58GB231280",57},
    {"CSISO60DANISHNORWEGIAN",25},
    {"CSISO60NORWEGIAN1",25},
    {"CSISO61NORWEGIAN2",58},
    {"CSISO646BASIC1983",28},
    {"CSISO646DANISH",99},
    {"CSISO6937ADD",93},
    {"CSISO69FRENCH",26},
    {"CSISO70VIDEOTEXSUPP1",59},
    {"CSISO84PORTUGUESE2",60},
    {"CSISO85SPANISH2",61},
    {"CSISO86HUNGARIAN",62},
    {"CSISO87JISX0208",63},
    {"CSISO885913",109},
    {"CSISO885914",110},
    {"CSISO885915",111},
    {"CSISO885916",112},
    {"CSISO88596E",81},
    {"CSISO88596I",82},
    {"CSISO88598E",84},
    {"CSISO88598I",85},
    {"CSISO8859SUPP",95},
    {"CSISO88GREEK7",64},
    {"CSISO89ASMO449",65},
    {"CSISO90",66},
    {"CSISO91JISC62291984A",67},
    {"CSISO92JISC62991984B",68},
    {"CSISO93JIS62291984BADD",69},
    {"CSISO94JIS62291984HAND",70},
    {"CSISO95JIS62291984HANDADD",71},
    {"CSISO96JISC62291984KANA",72},
    {"CSISO99NAPLPS",74},
    {"CSISOLATIN1",4},
    {"CSISOLATIN2",5},
    {"CSISOLATIN3",6},
    {"CSISOLATIN4",7},
    {"CSISOLATIN5",12},
    {"CSISOLATIN6",13},
    {"CSISOLATINARABIC",9},
    {"CSISOLATINCYRILLIC",8},
    {"CSISOLATINGREEK",10},
    {"CSISOLATINHEBREW",11},
    {"CSISOTEXTCOMM",14},
    {"CSJISENCODING",16},
    {"CSKOI7SWITCHED",2105},
    {"CSKOI8R",2084},
    {"CSKOI8U",2088},
    {"CSKSC56011987",36},
    {"CSKSC5636",102},
    {"CSKZ1048",119},
    {"CSMACINTOSH",2027},
    {"CSMICROSOFTPUBLISHING",2023},
    {"CSMNEM",2081},
    {"CSMNEMONIC",2080},
    {"CSNATSDANO",33},
    {"CSNATSDANOADD",34},
    {"CSNATSSEFI",31},
    {"CSNATSSEFIADD",32},
    {"CSN_369103",86},
    {"CSOSDEBCDICDF03IRV",116},
    {"CSOSDEBCDICDF041",117},
    {"CSOSDEBCDICDF0415",115},
    {"CSPC775BALTIC",2087},
    {"CSPC850MULTILINGUAL",2009},
    {"CSPC862LATINHEBREW",2013},
    {"CSPC8CODEPAGE437",2011},
    {"CSPC8DANISHNORWEGIAN",2012},
    {"CSPC8TURKISH",2014},
    {"CSPCP852",2010},
    {"CSPTCP154",2103},
    {"CSSCSU",1011},
    {"CSSHIFTJIS",17},
    {"CSTIS620",2259},
    {"CSTSCII",2107},
    {"CSUCS4",1001},
    {"CSUNICODE",1000},
    {"CSUNICODE11",1010},
    {"CSUNICODE11UTF7",103},
    {"CSUNICODEASCII",1002},
    {"CSUNICODEIBM1261",1005},
    {"CSUNICODEIBM1264",1008},
    {"CSUNICODEIBM1265",1009},
    {"CSUNICODEIBM1268",1006},
    {"CSUNICODEIBM1276",1007},
    {"CSUNICODEJAPANESE",1004},
    {"CSUNICODELATIN1",1003},
    {"CSUNKNOWN8BIT",2079},
    {"CSUSDK",100},
    {"CSUTF16",1015},
    {"CSUTF16BE",1013},
    {"CSUTF16LE",1014},
    {"CSUTF32",1017},
    {"CSUTF32BE",1018},
    {"CSUTF32LE",1019},
    {"CSUTF7",1012},
    {"CSUTF7IMAP",1021},
    {"CSUTF8",106},
    {"CSVENTURAINTERNATIONAL",2007},
    {"CSVENTURAMATH",2022},
    {"CSVENTURAUS",2006},
    {"CSVIQR",2083},
    {"CSVISCII",2082},
    {"CSWINDOWS1250",2250},
    {"CSWINDOWS1251",2251},
    {"CSWINDOWS1252",2252},
    {"CSWINDOWS1253",2253},
    {"CSWINDOWS1254",2254},
    {"CSWINDOWS1255",2255},
    {"CSWINDOWS1256",2256},
    {"CSWINDOWS1257",2257},
    {"CSWINDOWS1258",2258},
    {"CSWINDOWS30LATIN1",2000},
    {"CSWINDOWS31J",2024},
    {"CSWINDOWS31LATIN1",2001},
    {"CSWINDOWS31LATIN2",2002},
    {"CSWINDOWS31LATIN5",2003},
    {"CSWINDOWS874",2109},
    {"CUBA",92},
    {"CYRILLIC",8},
    {"CYRILLIC-ASIAN",2103},
    {"DE",24},
    {"DEC",2008},
    {"DEC-MCS",2008},
    {"DIN_66003",24},
    {"DK",99},
    {"DK-US",101},
    {"DS2089",99},
    {"DS_2089",99},
    {"E13B",73},
    {"EBCDIC-AT-DE",2064},
    {"EBCDIC-AT-DE-A",2065},
    {"EBCDIC-BE",2031},
    {"EBCDIC-BR",2032},
    {"EBCDIC-CA-FR",2066},
    {"EBCDIC-CP-AR1",2041},
    {"EBCDIC-CP-AR2",2062},
    {"EBCDIC-CP-BE",2044},
    {"EBCDIC-CP-CA",2028},
    {"EBCDIC-CP-CH",2044},
    {"EBCDIC-CP-DK",2033},
    {"EBCDIC-CP-ES",2037},
    {"EBCDIC-CP-FI",2034},
    {"EBCDIC-CP-FR",2040},
    {"EBCDIC-CP-GB",2038},
    {"EBCDIC-CP-GR",2042},
    {"EBCDIC-CP-HE",2043},
    {"EBCDIC-CP-IS",2056},
    {"EBCDIC-CP-IT",2035},
    {"EBCDIC-CP-NL",2028},
    {"EBCDIC-CP-NO",2033},
    {"EBCDIC-CP-ROECE",2055},
    {"EBCDIC-CP-SE",2034},
    {"EBCDIC-CP-TR",2061},
    {"EBCDIC-CP-US",2028},
    {"EBCDIC-CP-WT",2028},
    {"EBCDIC-CP-YU",2055},
    {"EBCDIC-CYRILLIC",2057},
    {"EBCDIC-DE-273+EURO",2092},
    {"EBCDIC-DK-277+EURO",2093},
    {"EBCDIC-DK-NO",2067},
    {"EBCDIC-DK-NO-A",2068},
    {"EBCDIC-ES",2074},
    {"EBCDIC-ES-284+EURO",2096},
    {"EBCDIC-ES-A",2075},
    {"EBCDIC-ES-S",2076},
    {"EBCDIC-FI-278+EURO",2094},
    {"EBCDIC-FI-SE",2069},
    {"EBCDIC-FI-SE-A",2070},
    {"EBCDIC-FR",2071},
    {"EBCDIC-FR-297+EURO",2098},
    {"EBCDIC-GB-285+EURO",2097},
    {"EBCDIC-INT",2029},
    {"EBCDIC-INTERNATIONAL-500+EURO",2099},
    {"EBCDIC-IS-871+EURO",2100},
    {"EBCDIC-IT",2072},
    {"EBCDIC-IT-280+EURO",2095},
    {"EBCDIC-JP-E",2036},
    {"EBCDIC-JP-KANA",2039},
    {"EBCDIC-LATIN9--EURO",2090},
    {"EBCDIC-NO-277+EURO",2093},
    {"EBCDIC-PT",2073},
    {"EBCDIC-SE-278+EURO",2094},
    {"EBCDIC-UK",2077},
    {"EBCDIC-US",2078},
    {"EBCDIC-US-37+EURO",2091},
    {"ECMA-114",9},
    {"ECMA-118",10},
    {"ECMA-CYRILLIC",77},
    {"ELOT_928",10},
    {"ES",23},
    {"ES2",61},
    {"EUC-JP",18},
    {"EUC-KR",38},
    {"EXTENDED_UNIX_CODE_FIXED_WIDTH_FOR_JAPANESE",19},
    {"EXTENDED_UNIX_CODE_PACKED_FORMAT_FOR_JAPANESE",18},
    {"FI",35},
    {"FR",26},
    {"GB",20},
    {"GB18030",114},
    {"GB2312",2025},
    {"GBK",113},
    {"GB_1988-80",56},
    {"GB_2312-80",57},
    {"GOST_19768-74",94},
    {"GREEK",10},
    {"GREEK-CCITT",91},
    {"GREEK7",64},
    {"GREEK7-OLD",44},
    {"GREEK8",10},
    {"HEBREW",11},
    {"HP-DESKTOP",2021},
    {"HP-LEGAL",2017},
    {"HP-MATH8",2019},
    {"HP-PI-FONT",2018},
    {"HP-ROMAN8",2004},
    {"HU",62},
    {"HZ-GB-2312",2085},
    {"IBM-1047",2102},
    {"IBM-SYMBOLS",2015},
    {"IBM-THAI",2016},
    {"IBM00858",2089},
    {"IBM00924",2090},
    {"IBM01140",2091},
    {"IBM01141",2092},
    {"IBM01142",2093},
    {"IBM01143",2094},
    {"IBM01144",2095},
    {"IBM01145",2096},
    {"IBM01146",2097},
    {"IBM01147",2098},
    {"IBM01148",2099},
    {"IBM01149",2100},
    {"IBM037",2028},
    {"IBM038",2029},
    {"IBM1026",2063},
    {"IBM1047",2102},
    {"IBM273",2030},
    {"IBM274",2031},
    {"IBM275",2032},
    {"IBM277",2033},
    {"IBM278",2034},
    {"IBM280",2035},
    {"IBM281",2036},
    {"IBM284",2037},
    {"IBM285",2038},
    {"IBM290",2039},
    {"IBM297",2040},
    {"IBM367",3},
    {"IBM420",2041},
    {"IBM423",2042},
    {"IBM424",2043},
    {"IBM437",2011},
    {"IBM500",2044},
    {"IBM775",2087},
    {"IBM819",4},
    {"IBM850",2009},
    {"IBM851",2045},
    {"IBM852",2010},
    {"IBM855",2046},
    {"IBM857",2047},
    {"IBM860",2048},
    {"IBM861",2049},
    {"IBM862",2013},
    {"IBM863",2050},
    {"IBM864",2051},
    {"IBM865",2052},
    {"IBM866",2086},
    {"IBM868",2053},
    {"IBM869",2054},
    {"IBM870",2055},
    {"IBM871",2056},
    {"IBM880",2057},
    {"IBM891",2058},
    {"IBM903",2059},
    {"IBM904",2060},
    {"IBM905",2061},
    {"IBM918",2062},
    {"IEC_P27-1",88},
    {"INIS",51},
    {"INIS-8",52},
    {"INIS-CYRILLIC",53},
    {"INVARIANT",29},
    {"IRV",30},
    {"ISO-10646",1003},
    {"ISO-10646-J-1",1004},
    {"ISO-10646-UCS-2",1000},
    {"ISO-10646-UCS-4",1001},
    {"ISO-10646-UCS-BASIC",1002},
    {"ISO-10646-UNICODE-LATIN1",1003},
    {"ISO-10646-UTF-1",27},
    {"ISO-11548-1",118},
    {"ISO-2022-CN",104},
    {"ISO-2022-CN-EXT",105},
    {"ISO-2022-JP",39},
    {"ISO-2022-JP-2",40},
    {"ISO-2022-KR",37},
    {"ISO-8859-1",4},
    {"ISO-8859-1-WINDOWS-3.0-LATIN-1",2000},
    {"ISO-8859-1-WINDOWS-3.1-LATIN-1",2001},
    {"ISO-8859-10",13},
    {"ISO-8859-11",2259},
    {"ISO-8859-13",109},
    {"ISO-8859-14",110},
    {"ISO-8859-15",111},
    {"ISO-8859-16",112},
    {"ISO-8859-2",5},
    {"ISO-8859-2-WINDOWS-LATIN-2",2002},
    {"ISO-8859-3",6},
    {"ISO-8859-4",7},
    {"ISO-8859-5",8},
    {"ISO-8859-6",9},
    {"ISO-8859-6-E",81},
    {"ISO-8859-6-I",82},
    {"ISO-8859-7",10},
    {"ISO-8859-8",11},
    {"ISO-8859-8-E",84},
    {"ISO-8859-8-I",85},
    {"ISO-8859-9",12},
    {"ISO-8859-9-WINDOWS-LATIN-5",2003},
    {"ISO-CELTIC",110},
    {"ISO-IR-10",35},
    {"ISO-IR-100",4},
    {"ISO-IR-101",5},
    {"ISO-IR-102",75},
    {"ISO-IR-103",76},
    {"ISO-IR-109",6},
    {"ISO-IR-11",21},
    {"ISO-IR-110",7},
    {"ISO-IR-111",77},
    {"ISO-IR-121",78},
    {"ISO-IR-122",79},
    {"ISO-IR-123",80},
    {"ISO-IR-126",10},
    {"ISO-IR-127",9},
    {"ISO-IR-128",83},
    {"ISO-IR-13",41},
    {"ISO-IR-138",11},
    {"ISO-IR-139",86},
    {"ISO-IR-14",42},
    {"ISO-IR-141",87},
    {"ISO-IR-142",14},
    {"ISO-IR-143",88},
    {"ISO-IR-144",8},
    {"ISO-IR-146",89},
    {"ISO-IR-147",90},
    {"ISO-IR-148",12},
    {"ISO-IR-149",36},
    {"ISO-IR-15",22},
    {"ISO-IR-150",91},
    {"ISO-IR-151",92},
    {"ISO-IR-152",93},
    {"ISO-IR-153",94},
    {"ISO-IR-154",95},
    {"ISO-IR-155",96},
    {"ISO-IR-157",13},
    {"ISO-IR-158",97},
    {"ISO-IR-159",98},
    {"ISO-IR-16",43},
    {"ISO-IR-17",23},
    {"ISO-IR-18",44},
    {"ISO-IR-19",45},
    {"ISO-IR-199",110},
    {"ISO-IR-2",30},
    {"ISO-IR-21",24},
    {"ISO-IR-226",112},
    {"ISO-IR-25",46},
    {"ISO-IR-27",47},
    {"ISO-IR-37",48},
    {"ISO-IR-4",20},
    {"ISO-IR-42",49},
    {"ISO-IR-47",50},
    {"ISO-IR-49",51},
    {"ISO-IR-50",52},
    {"ISO-IR-51",53},
    {"ISO-IR-54",54},
    {"ISO-IR-55",55},
    {"ISO-IR-57",56},
    {"ISO-IR-58",57},
    {"ISO-IR-6",3},
    {"ISO-IR-60",25},
    {"ISO-IR-61",58},
    {"ISO-IR-69",26},
    {"ISO-IR-70",59},
    {"ISO-IR-8-1",31},
    {"ISO-IR-8-2",32},
    {"ISO-IR-84",60},
    {"ISO-IR-85",61},
    {"ISO-IR-86",62},
    {"ISO-IR-87",63},
    {"ISO-IR-88",64},
    {"ISO-IR-89",65},
    {"ISO-IR-9-1",33},
    {"ISO-IR-9-2",34},
    {"ISO-IR-90",66},
    {"ISO-IR-91",67},
    {"ISO-IR-92",68},
    {"ISO-IR-93",69},
    {"ISO-IR-94",70},
    {"ISO-IR-95",71},
    {"ISO-IR-96",72},
    {"ISO-IR-98",73},
    {"ISO-IR-99",74},
    {"ISO-UNICODE-IBM-1261",1005},
    {"ISO-UNICODE-IBM-1264",1008},
    {"ISO-UNICODE-IBM-1265",1009},
    {"ISO-UNICODE-IBM-1268",1006},
    {"ISO-UNICODE-IBM-1276",1007},
    {"ISO5427CYRILLIC1981",54},
    {"ISO646-CA",78},
    {"ISO646-CA2",79},
    {"ISO646-CN",56},
    {"ISO646-CU",92},
    {"ISO646-DE",24},
    {"ISO646-DK",99},
    {"ISO646-ES",23},
    {"ISO646-ES2",61},
    {"ISO646-FI",35},
    {"ISO646-FR",26},
    {"ISO646-FR1",46},
    {"ISO646-GB",20},
    {"ISO646-HU",62},
    {"ISO646-IT",22},
    {"ISO646-JP",42},
    {"ISO646-JP-OCR-B",68},
    {"ISO646-KR",102},
    {"ISO646-NO",25},
    {"ISO646-NO2",58},
    {"ISO646-PT",43},
    {"ISO646-PT2",60},
    {"ISO646-SE",35},
    {"ISO646-SE2",21},
    {"ISO646-US",3},
    {"ISO646-YU",87},
    {"ISO_10367-BOX",96},
    {"ISO_11548-1",118},
    {"ISO_2033-1983",73},
    {"ISO_5427",48},
    {"ISO_5427:1981",54},
    {"ISO_5428:1980",55},
    {"ISO_646.BASIC:1983",28},
    {"ISO_646.IRV:1983",30},
    {"ISO_646.IRV:1991",3},
    {"ISO_6937-2-25",93},
    {"ISO_6937-2-ADD",14},
    {"ISO_8859-1",4},
    {"ISO_8859-10:1992",13},
    {"ISO_8859-14",110},
    {"ISO_8859-14:1998",110},
    {"ISO_8859-15",111},
    {"ISO_8859-16",112},
    {"ISO_8859-16:2001",112},
    {"ISO_8859-1:1987",4},
    {"ISO_8859-2",5},
    {"ISO_8859-2:1987",5},
    {"ISO_8859-3",6},
    {"ISO_8859-3:1988",6},
    {"ISO_8859-4",7},
    {"ISO_8859-4:1988",7},
    {"ISO_8859-5",8},
    {"ISO_8859-5:1988",8},
    {"ISO_8859-6",9},
    {"ISO_8859-6-E",81},
    {"ISO_8859-6-I",82},
    {"ISO_8859-6:1987",9},
    {"ISO_8859-7",10},
    {"ISO_8859-7:1987",10},
    {"ISO_8859-8",11},
    {"ISO_8859-8-E",84},
    {"ISO_8859-8-I",85},
    {"ISO_8859-8:1988",11},
    {"ISO_8859-9",12},
    {"ISO_8859-9:1989",12},
    {"ISO_8859-SUPP",95},
    {"ISO_9036",65},
    {"ISO_TR_11548-1",118},
    {"IT",22},
    {"JIS_C6220-1969",41},
    {"JIS_C6220-1969-JP",41},
    {"JIS_C6220-1969-RO",42},
    {"JIS_C6226-1978",49},
    {"JIS_C6226-1983",63},
    {"JIS_C6229-1984-A",67},
    {"JIS_C6229-1984-B",68},
    {"JIS_C6229-1984-B-ADD",69},
    {"JIS_C6229-1984-HAND",70},
    {"JIS_C6229-1984-HAND-ADD",71},
    {"JIS_C6229-1984-KANA",72},
    {"JIS_ENCODING",16},
    {"JIS_X0201",15},
    {"JIS_X0208-1983",63},
    {"JIS_X0212-1990",98},
    {"JP",42},
    {"JP-OCR-A",67},
    {"JP-OCR-B",68},
    {"JP-OCR-B-ADD",69},
    {"JP-OCR-HAND",70},
    {"JP-OCR-HAND-ADD",71},
    {"JS",87},
    {"JUS_I.B1.002",87},
    {"JUS_I.B1.003-MAC",90},
    {"JUS_I.B1.003-SERB",89},
    {"KATAKANA",41},
    {"KOI7-SWITCHED",2105},
    {"KOI8-E",77},
    {"KOI8-R",2084},
    {"KOI8-U",2088},
    {"KOREAN",36},
    {"KSC5636",102},
    {"KSC_5601",36},
    {"KS_C_5601-1987",36},
    {"KS_C_5601-1989",36},
    {"KZ-1048",119},
    {"L1",4},
    {"L10",112},
    {"L2",5},
    {"L3",6},
    {"L4",7},
    {"L5",12},
    {"L6",13},
    {"L8",110},
    {"LAP",97},
    {"LATIN-9",111},
    {"LATIN-GREEK",45},
    {"LATIN-GREEK-1",47},
    {"LATIN-LAP",97},
    {"LATIN1",4},
    {"LATIN1-2-5",95},
    {"LATIN10",112},
    {"LATIN2",5},
    {"LATIN3",6},
    {"LATIN4",7},
    {"LATIN5",12},
    {"LATIN6",13},
    {"LATIN8",110},
    {"MAC",2027},
    {"MACEDONIAN",90},
    {"MACINTOSH",2027},
    {"MICROSOFT-PUBLISHING",2023},
    {"MNEM",2081},
    {"MNEMONIC",2080},
    {"MS936",113},
    {"MSZ_7795.3",62},
    {"MS_KANJI",17},
    {"NAPLPS",74},
    {"NATS-DANO",33},
    {"NATS-DANO-ADD",34},
    {"NATS-SEFI",31},
    {"NATS-SEFI-ADD",32},
    {"NC_NC00-10:81",92},
    {"NF_Z_62-010",26},
    {"NF_Z_62-010_(1973)",46},
    {"NO",25},
    {"NO2",58},
    {"NS_4551-1",25},
    {"NS_4551-2",58},
    {"OSD_EBCDIC_DF03_IRV",116},
    {"OSD_EBCDIC_DF04_1",117},
    {"OSD_EBCDIC_DF04_15",115},
    {"PC-MULTILINGUAL-850+EURO",2089},
    {"PC8-DANISH-NORWEGIAN",2012},
    {"PC8-TURKISH",2014},
    {"PT",43},
    {"PT154",2103},
    {"PT2",60},
    {"PTCP154",2103},
    {"R8",2004},
    {"REF",28},
    {"RK1048",119},
    {"ROMAN8",2004},
    {"SCSU",1011},
    {"SE",35},
    {"SE2",21},
    {"SEN_850200_B",35},
    {"SEN_850200_C",21},
    {"SERBIAN",89},
    {"SHIFT_JIS",17},
    {"STRK1048-2002",119},
    {"ST_SEV_358-88",94},
    {"T.101-G2",83},
    {"T.61",76},
    {"T.61-7BIT",75},
    {"T.61-8BIT",76},
    {"TIS-620",2259},
    {"TSCII",2107},
    {"UK",20},
    {"UNICODE-1-1",1010},
    {"UNICODE-1-1-UTF-7",103},
    {"UNKNOWN-8BIT",2079},
    {"US",3},
    {"US-ASCII",3},
    {"US-DK",100},
    {"UTF-16",1015},
    {"UTF-16BE",1013},
    {"UTF-16LE",1014},
    {"UTF-32",1017},
    {"UTF-32BE",1018},
    {"UTF-32LE",1019},
    {"UTF-7",1012},
    {"UTF-7-IMAP",1021},
    {"UTF-8",106},
    {"VENTURA-INTERNATIONAL",2007},
    {"VENTURA-MATH",2022},
    {"VENTURA-US",2006},
    {"VIDEOTEX-SUPPL",59},
    {"VIQR",2083},
    {"VISCII",2082},
    {"WINDOWS-1250",2250},
    {"WINDOWS-1251",2251},
    {"WINDOWS-1252",2252},
    {"WINDOWS-1253",2253},
    {"WINDOWS-1254",2254},
    {"WINDOWS-1255",2255},
    {"WINDOWS-1256",2256},
    {"WINDOWS-1257",2257},
    {"WINDOWS-1258",2258},
    {"WINDOWS-31J",2024},
    {"WINDOWS-874",2109},
    {"WINDOWS-936",113},
    {"X0201",15},
    {"X0201-7",41},
    {"X0208",63},
    {"X0212",98},
    {"YU",87},
    {"UHC", 38},
    {"EUC-TW",9991},
    {"MAC-CENTRALEUROPE", 10029},
    {"MAC-CYRILLIC",10007},
    {"X-MAC-CE", 10029},
    {"CP10029", 10029},
    {"X-MAC-CYRILLIC",10007}
};

MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , ui(new Ui::MainWindow)
{
    ui->setupUi(this);

    connect(ui->actionQuit, &QAction::triggered, this, &MainWindow::close);
    connect(ui->actionOpen, &QAction::triggered, this, &MainWindow::openFile);

    QMap<QString, int> rev;    
    QMapIterator<int,QByteArray> it(charsets);
    while(it.hasNext()) {
        it.next();
        rev.insert(it.value(), it.key());
    }
    QMapIterator<QString,int> ir(rev);
    while(ir.hasNext()) {
        ir.next();
        ui->comboBox->addItem(ir.key(), ir.value());
    }
    ui->comboBox->setCurrentIndex(-1);
    connect(ui->comboBox, QOverload<int>::of(&QComboBox::currentIndexChanged), this, &MainWindow::slotDecode);
}

MainWindow::~MainWindow()
{
    delete ui;
}

void MainWindow::openFile()
{
    QFileDialog dlg(this);
    dlg.setFileMode(QFileDialog::ExistingFile);
    dlg.setNameFilter(tr("Text Files (*.txt)"));
    dlg.setViewMode(QFileDialog::List);

    if (dlg.exec() == QDialog::Accepted) {
        QStringList fileNames = dlg.selectedFiles();
        QFileInfo fi(fileNames.first());
        QFile f(fi.absoluteFilePath());
        if (f.open(QIODevice::ReadOnly)) {
            m_data = f.readAll();
            ui->textEdit->clear();
            setWindowTitle("IconvQtPOC: " + fi.fileName());
            f.close();
            QByteArray cs = detectCharset();
            if (!cs.isEmpty() && aliases.contains(cs)) {
                int idx = ui->comboBox->findData(aliases[cs]);
                if (idx == ui->comboBox->currentIndex()) {
                    slotDecode(idx);
                } else {
                    ui->comboBox->setCurrentIndex(idx);
                }
            } else {
                ui->comboBox->setCurrentIndex(-1);
            }
        }
    }
}

void MainWindow::slotDecode(const int idx)
{
    qDebug() << Q_FUNC_INFO << idx;
    ui->textEdit->clear();
    if (idx >= 0) {
        int mib = ui->comboBox->itemData(idx).toInt();
        QByteArray charset = charsets[mib];
        try {
            IconvConverter dc(charset);
            QString str = QString::fromUtf8(dc.convert(m_data));
            ui->textEdit->setText(str);
        } catch (std::runtime_error& err) {
            qWarning() << err.what();
        }
    }
}

QByteArray MainWindow::detectCharset()
{
    QByteArray charset;
    uchardet_t handle = uchardet_new();
    try {
        uchardet_reset(handle);
        uchardet_handle_data(handle, m_data.data(), m_data.count());
        uchardet_data_end(handle);
        charset = uchardet_get_charset(handle);
        qDebug() << Q_FUNC_INFO << "Detected charset:" << charset;
    } catch (...) {
        qWarning() << "uchardet error!";
    } 
    uchardet_delete(handle);
    return charset;
}
